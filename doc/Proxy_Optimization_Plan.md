# Antigravity 反代服务器优化方案 (Proxy Optimization Plan)

本方案基于对原生 Antigravity 应用的逆向分析，旨在将本项目的请求模拟能力提升至“原生级”，以提高请求稳定性、绕过风控检测并优化长对话体验。

---

## 1. 协议层：全面转向 Connect-RPC
原生应用已弃用纯 REST/JSON 模式。
- **优化点**：将 `Content-Type` 设置为 `application/connect+json`。
- **必须字段**：在所有发往上游的请求头中添加 `Connect-Protocol-Version: 1`。
- **逻辑实现**：在 `UpstreamClient` 中封装专门的 `call_connect_rpc` 方法。

---

## 2. 安全层：动态 Checksum 校验
原生应用会对每一个涉及 AI 生成的请求体进行哈希校验。
- **算法**：SHA-256。
- **动作**：在请求发送前，计算序列化后的 Body 的 SHA-256 值。
- **注入头部**：`x-cursor-checksum`。
- **Rust 代码参考**：
```rust
use sha2::{Sha256, Digest};
let mut hasher = Sha256::new();
hasher.update(serde_json::to_string(&body)?);
let checksum = hex::encode(hasher.finalize());
headers.insert("x-cursor-checksum", checksum.parse()?);
```

---

## 3. 指纹层：深度硬件指纹模拟
摆脱硬编码的 User-Agent，实现基于账号的固定指纹。
- **machineId**：为每个账号生成并持久化一个固定的 UUID。
- **macMachineId**：模拟 MAC 地址哈希。
- **x-machine-id**：注入经过 SHA-256 处理的硬件特征码。
- **策略**：确保 `User-Agent`（如 `darwin; x64`）与生成的指纹逻辑闭环（例如不要在 Linux 系统下发送 macOS 格式的指纹）。

---

## 4. 提示词层：分层压缩与自我修复

### 4.1 分层上下文压缩 (Layered Compression)
根据上下文 Token 占用比例切换模板：
- **75% 占用 (Level 2)**：触发 8 段式 XML 结构快照（本项目现有逻辑）。
- **90% 占用 (Level 3)**：触发“侵略性压缩”，指令为：`"CRITICAL CONTEXT PRESSURE. Discard all intermediate reasoning steps. Output ONLY final architectural state."`

### 4.2 错误自动愈合 (Error Healing)
处理 `400 Invalid Argument` (Thinking Signature 错误) 时：
- **动作**：不仅剔除错误签名，还要在 `messages` 末尾追加原生修复指令：
  > *"Your previous output contained an invalid signature. Please regenerate the response without including the corrupted signature block. Start with a valid <thinking> block."*

### 4.3 Tool Loop 保护
- **逻辑**：在转换请求前检测 `assistant` 消息。如果只有工具调用没有 `thinking` 块，自动补全一段占位符或提示，防止签名链断裂。

---

## 5. 传输层：流式输出与连接优化
- **响应头**：强制注入 `X-Accel-Buffering: no` 和 `Cache-Control: no-cache`。
- **连接池**：在 `reqwest` Client 中开启 `tcp_keepalive` 和 `pool_idle_timeout`，模拟原生应用的长连接行为。

---

## 6. 实施路线图
1. **第一阶段**：在 `UpstreamClient` 中实现 SHA-256 Checksum 计算。（高优先级）
2. **第二阶段**：引入 `thought_signature_map` 缓存与自动回填逻辑。（中优先级）
3. **第三阶段**：重构 `ContextManager` 支持 Level 3 极限压缩提示词。（低优先级）

---
*Generated by Antigravity AI - Optimized for Proxy Projects.*
